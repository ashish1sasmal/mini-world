<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>Mini World</title>
    <style media="screen">
        .dot {
          height: 12px;
          width: 12px;
          background-color: #13b002;
          border-radius: 50%;
          display: inline-block;
        }

        .active-button{
            border-color:#646664;

        }

        .mycontent-left {
              border-right: 1px solid #c1c5c9;
            }

            li:hover{
            background-color: #e6e6e6;
            }

            .chat-online {
        color: #34ce57
    }

    .chat-offline {
        color: #e4606d
    }

    .chat-messages {
        display: flex;
        flex-direction: column;
        max-height: 500px;
        overflow-y: scroll
    }

    .chat-message-left,
    .chat-message-right {
        display: flex;
        flex-shrink: 0
    }

    .chat-message-left {
        margin-right: auto
    }

    .chat-message-right {
        flex-direction: row-reverse;
        margin-left: auto
    }
    .py-3 {
        padding-top: 1rem!important;
        padding-bottom: 1rem!important;
    }
    .px-4 {
        padding-right: 1.5rem!important;
        padding-left: 1.5rem!important;
    }
    .flex-grow-0 {
        flex-grow: 0!important;
    }
    .border-top {
        border-top: 1px solid #dee2e6!important;
    }

                </style>
  </head>
  <body>
  <div class="container">
  <nav class="navbar navbar-expand-lg navbar-light bg-light" style="border-bottom:1px solid #c1c5c9;">
      <div class="container-fluid">
<a class="navbar-brand" href="#"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/de/Google_Chat_icon_%282020%29.svg/1200px-Google_Chat_icon_%282020%29.svg.png" alt="" style="width:20px;"> Mini World</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
  <span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNavDropdown">
    <form class="d-flex" >
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">Search</button>
      </form>
  <ul class="navbar-nav" >

    <li class="nav-item dropdown" id="active_link" style="display:none;">
          <a class="nav-link dropdown-toggle " href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" >
        <span class="dot"></span> Active
      </a>
      <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
        <li><a class="dropdown-item" href="#">Action</a></li>
        <li><a class="dropdown-item" href="#">Another action</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" onclick="logout();">Logout</a></li>
      </ul>
    </li>
    <li class="nav-item" id="login_link" style="display:none;">
      <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Login</a>
    </li>

  </ul>
</div>
</div>

    </nav>

        <div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Create Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form >
                  <div class="modal-body">
                      <div class="mb-3">
                          <label for="room_name" class="form-label">Room Name</label>
                          <input type="text" class="form-control" id="groupName" aria-describedby="emailHelp">
                          <div id="emailHelp" class="form-text">Choose some funky names</div>
                        </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" onclick="makeGroup();" class="btn btn-primary">Create</button>
                  </div>
              </form>

            </div>
          </div>
        </div>

        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog  modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Login</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="loginForm">
                  <div class="modal-body">
                      <div class="mb-3">
                          <label for="room_name" class="form-label">Email</label>
                          <input type="email" name="emaillogin" class="form-control" id="emaillogin" aria-describedby="emailHelp">
                        </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" onclick="login(this);" class="btn btn-primary">Login</button>
                  </div>
              </form>

            </div>
          </div>
        </div>

    <div class="row" style="height:100%">
        <div class="d-flex align-items-start">
            <div class="col-3">
                <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <button class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill" data-bs-target="#v-pills-home" type="button" role="tab" aria-controls="v-pills-home" aria-selected="true">Home</button>
                 {% for chat in chlist %}

                  <button class="nav-link" data-bs-toggle="" aria-expanded="false" id="v-pills-{{chat.code}}-tab" data-bs-toggle="pill" data-bs-target="#v-pills-{{chat.code}}" type="button" role="tab" aria-controls="v-pills-{{chat.code}}" aria-selected="true">{{chat.name}}</button>
                  <ul class="dropdown-menu">
                       <li><a class="dropdown-item" onclick="leavegroup('{{chat.code}}');" href="#"><i class="fas fa-arrow-left"></i> Leave Room</a></li>
                       <li><a class="dropdown-item" href="#"><i class="fas fa-users"></i> Members</a></li>
                  </ul>
                  {% endfor %}
                </div>
            </div>
            <div class="col-9">
                <div class="tab-content" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">...</div>

                {% for chat in chlist %}
                  <div class="tab-pane fade show" id="v-pills-{{chat.code}}" role="tabpanel" aria-labelledby="v-pills-{{chat.code}}-tab">...</div>
                  {% endfor %}

                </div>
            </div>


    </div>
    </div>


  <script src="https://code.jquery.com/jquery-3.6.0.slim.js" integrity="sha256-HwWONEZrpuoh951cQD1ov2HUK5zA5DwJ1DNUXaM6FsY=" crossorigin="anonymous"></script>

  {{ username|json_script:"user_username" }}

  <script type="text/javascript">
    {% if login %}
    document.getElementById('active_link').style.display = "block";
    {% else %}
    document.getElementById('login_link').style.display = "block";
    {% endif %}
    const csrf_token = '{{ csrf_token }}';
    // const getFormJSON = (form) => {
    //   const data = new FormData(form);
    //   return Array.from(data.keys()).reduce((result, key) => {
    //     result[key] = data.get(key);
    //     return result;
    //   }, {});
    // };

    var chatSocket=null;

    function startChat(roomCode){
        if (roomCode != null)
        {
            if (chatSocket !=null){
                chatSocket.close();
            }

            var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
            chatSocket = new WebSocket(ws_scheme+'://' +window.location.host +'/ws/chat/' +roomCode +'/');
        }
    }



    function getCookie(name) {
   let cookieValue = null;
   if (document.cookie && document.cookie !== '') {
       const cookies = document.cookie.split(';');
       for (let i = 0; i < cookies.length; i++) {
           const cookie = cookies[i].trim();
           // Does this cookie string begin with the name we want?
           if (cookie.substring(0, name.length + 1) === (name + '=')) {
               cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
               break;
           }
       }
   }
   return cookieValue;
}

    async function makePOSTRequest(url,formData){
        const otherPram={
            body:formData,
            method:"POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken")
            },
            mode: "same-origin",
        };

        let response = await fetch(url, otherPram);
        let status = await response.status;
        if (status==200){
            return true;
        }
        else if (status==400){
            return false;
        }
        else if(status == 500){
            alert("Some error occured. Please try again");
            return false;
        }
    }

    async function makeGETRequest(url){
        let response = await fetch(url);
        let status = await response.status;
        if (status==200){
            return true;
        }
        else if (status==400){
            return false;
        }
        else if(status == 500){
            alert("Some error occured. Please try again");
            return false;
        }
    }

    async function checkLogin(){
        res = await makeGETRequest("{% url 'chat:checkLogin' %}");
        return res;
    }



    async function logout(){
        let res = await makeGETRequest("{% url 'chat:logout' %}")
        if (res){
            document.getElementById('login_link').style.display = "block";
            document.getElementById('active_link').style.display = "none";
        }
    }



    async function login() {
        const formData = new FormData();
         formData.append('emaillogin',document.getElementById('emaillogin').value);
        res = await makePOSTRequest("{% url 'chat:login' %}",formData);
        if (res){
            document.getElementById('login_link').style.display = "none";
            document.getElementById('active_link').style.display = "block";
            $('#loginModal').modal('hide');
        }
    }

    function makeGroup(){
        groupName = document.getElementById('groupName').value;
        const formData = new FormData();
         formData.append('groupName', groupName);
         const otherPram={
             body:formData,
             method:"POST",
             headers: {
                 "X-CSRFToken": getCookie("csrftoken")
             },
             mode: "same-origin",
         };

         fetch("{% url 'chat:newchat' %}", otherPram).then(res=>res.json())
         .then(data=>{
             $('#createRoomModal').modal('hide');
             document.getElementById("chatlist").innerHTML=
             `
             <a href="#"  id="${data.room_code}">
             <li style="overflow: hidden;" class="mt-2">
                 <p style="float: left;">${groupName}</p>
                 <a style="float: right;" href="#" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></a>
                 <ul class="dropdown-menu">
                      <li><a class="dropdown-item" onclick="leavegroup('${data.room_code}');" href="#"><i class="fas fa-arrow-left"></i> Leave Room</a></li>
                      <li><a class="dropdown-item" href="#"><i class="fas fa-users"></i> Members</a></li>
                 </ul>
             </li>
             </a>
             `+ document.getElementById("chatlist").innerHTML;
         });
    }

    function leavegroup(code){
        // alert("{% url 'chat:leavegroup' %}?roomcode="+code);
        fetch("{% url 'chat:leavegroup' %}?roomcode="+code).then(res=>res.json())
        .then(data=>{
            document.getElementById(code).style.display = "none";
        });
    }

  </script>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>
    -->
  </body>
</html>
